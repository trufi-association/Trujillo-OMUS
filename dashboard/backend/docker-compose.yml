# Docker Compose - Production Configuration (default)
# For production: docker compose up -d
# For development: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build

services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-omus}
    restart: unless-stopped
    volumes:
      - ./db/conf.d:/etc/mysql/conf.d
      - ./db/logs:/logs
      - ./database:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build: .
    container_name: omus-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./scripts:/app/scripts
      - ../../GTFS-Peru-Trujillo:/app/gtfs_builder
      - ../../dashboard/omus/build/web/assets/assets/gtfs:/app/gtfs
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=db;Database=${MYSQL_DATABASE:-omus};User=root;Password=${MYSQL_ROOT_PASSWORD};
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=${API_URL}
      - Jwt__Audience=${API_URL}
      - ApiKey=${API_KEY}
      - TextIt__Token=${TEXTIT_TOKEN}
      - Admin__Username=${ADMIN_USERNAME}
      - Admin__Password=${ADMIN_PASSWORD}
      - Cors__Origins=${CORS_ORIGINS}
      - Cors__AllowLocalhost=${CORS_ALLOW_LOCALHOST:-false}
      - Proxy__AllowedDomains=${PROXY_ALLOWED_DOMAINS}

networks:
  default:
    external: true
    name: trufi-server
